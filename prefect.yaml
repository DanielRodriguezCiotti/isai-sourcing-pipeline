# Production Prefect Configuration
prefect-version: 3.4.2
name: workflows

build:
- prefect_docker.deployments.steps.build_docker_image:
    id: build-image
    image_name: "{{ $AWS_ECR_REPOSITORY }}"
    tag: "{{ $IMAGE_TAG }}"
    dockerfile: Dockerfile

push:
- prefect.deployments.steps.run_shell_script:
    id: ecr-login
    script: |
      /bin/sh -c 'aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $AWS_ECR_REPOSITORY'
    stream_output: true
    expand_env_vars: true
- prefect_docker.deployments.steps.push_docker_image:
    image_name: "{{ $AWS_ECR_REPOSITORY }}"
    tag: "{{ $IMAGE_TAG }}"

definitions:
  actions:
    pull_action: &pull_action
      - prefect.deployments.steps.set_working_directory:
          directory: /data-pipeline/

deployments:

- name: ingest-trigger-deployment
  version: 0.1.0
  tags: ["ingest-trigger"]
  description: "Ingest trigger deployment"
  schedule:
  entrypoint: src/flows/ingest_trigger.py:ingest_trigger_flow
  parameters:
    supabase_file_path: dani_d_com_2026-02-11T21-16-58-551Z.xlsx
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 1024
      family: ingest-trigger
      memory: 2048
      cloudwatch_logs_options:
        awslogs-stream-prefix: ingest-trigger

  pull: *pull_action

- name: full-pipeline-deployment
  version: 0.1.0
  tags: ["full-pipeline"]
  description: "Full pipeline deployment"
  schedule:
  entrypoint: src/flows/full_pipeline.py:full_pipeline_flow
  parameters:
    domains: 
      - aceiss.com
      - acelfil.com
      - acerta.ai
      - acodis.io
      - actifile.com
      - activatedscale.com
      - activecharge.us
      - activecomply.com
      - acumen.network
      - adaptavate.com
      - adaptional.com
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 4096
      family: full-pipeline
      memory: 8192
      cloudwatch_logs_options:
        awslogs-stream-prefix: full-pipeline

  pull: *pull_action

- name: enrichment-deployment
  version: 0.1.0
  tags: ["enrichment"]
  description: "Enrichment deployment"
  schedule:
  entrypoint: src/flows/enrichment.py:enrichment_flow
  parameters:
    domains: 
      - aceiss.com
      - acelfil.com
      - acerta.ai
      - acodis.io
      - actifile.com
      - activatedscale.com
      - activecharge.us
      - activecomply.com
      - acumen.network
      - adaptavate.com
      - adaptional.com
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 4096
      family: enrichment
      memory: 8192
      cloudwatch_logs_options:
        awslogs-stream-prefix: enrichment

  pull: *pull_action

- name: business-processing-deployment
  version: 0.1.0
  tags: ["business-processing"]
  description: "Business processing deployment"
  schedule:
  entrypoint: src/flows/business_processing.py:business_processing_flow
  parameters:
    domains: 
      - aceiss.com
      - acelfil.com
      - acerta.ai
      - acodis.io
      - actifile.com
      - activatedscale.com
      - activecharge.us
      - activecomply.com
      - acumen.network
      - adaptavate.com
      - adaptional.com
    config:
      sync_attio_status: true
      compute_fuzzy_matching_metrics: true
      compute_funding_metrics: true
      compute_founders_values: true
      annotate_company_tags: true
      compute_scores: true
    recompute_all: false
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 4096
      family: business
      memory: 8192
      cloudwatch_logs_options:
        awslogs-stream-prefix: business

  pull: *pull_action

- name: reconciliation-deployment
  version: 0.1.0
  tags: ["reconciliation"]
  description: "Reconciliation deployment"
  schedule:
  entrypoint: src/flows/reconciliation.py:reconciliation_flow
  parameters:
    domains: 
      - aceiss.com
      - acelfil.com
      - acerta.ai
      - acodis.io
      - actifile.com
      - activatedscale.com
      - activecharge.us
      - activecomply.com
      - acumen.network
      - adaptavate.com
      - adaptional.com
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 1024
      family: reconciliation
      memory: 2048
      cloudwatch_logs_options:
        awslogs-stream-prefix: reconciliation

  pull: *pull_action

- name: website-enrichment-deployment
  version: 0.1.0
  tags: ["website-enrichment"]
  description: "Website enrichment deployment"
  schedule:
  entrypoint: src/flows/website_enrichment.py:website_enrichment_flow
  parameters:
    domains: 
      - aceiss.com
      - acelfil.com
      - acerta.ai
      - acodis.io
      - actifile.com
      - activatedscale.com
      - activecharge.us
      - activecomply.com
      - acumen.network
      - adaptavate.com
      - adaptional.com
  work_pool: 
    name: ecs-push-pool
    job_variables:
      cpu: 4096
      family: website-enrichment
      memory: 8192
      cloudwatch_logs_options:
        awslogs-stream-prefix: reconciliation

  pull: *pull_action


